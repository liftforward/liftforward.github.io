<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Authentication via Google Oauth2 with Ember-Simple-Auth and Torii</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://tech.liftforward.com/jekyll/update/2015/12/18/welcome-to-jekyll.html">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">LiftForward Tech Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Authentication via Google Oauth2 with Ember-Simple-Auth and Torii</h1>
    <p class="post-meta">Dec 18, 2015</p>
  </header>

  <article class="post-content">
    <p>How to setup and use ember-simple-auth 1.0+ with torii and google oauth2 authentication.</p>

<h3 id="getting-google-oauth-keys">Getting Google OAUTH Keys</h3>

<p><a href="https://developers.google.com/identity/protocols/OAuth2">This page</a> gives a overview of the process but I’ll walk you through the basic steps here. (if you have already completed this you can skip to Creating your ember project).</p>

<ol>
  <li>First you need create your account by visiting here: https://console.developers.google.com and signup with your gmail account. (I used my private account for this walkthough and I don’t believe I had registered it before. Hopefully your experience is the same.)</li>
  <li>Once you’re signed in you’ll want to enable apis for your project. In my case this also required creating the application.<br />
TODO add the rest with screen shots</li>
</ol>

<h3 id="create-your-ember-project">Create your ember project</h3>

<p>Here I’m assuming you’ve already installed ember and are familiar with it. If not <a href="http://lmgtfy.com/?q=installing+ember">click here</a></p>

<pre><code>ember init ember-simple-auth-torii-google
</code></pre>

<h3 id="install-simple-auth-and-tori">Install simple auth and tori</h3>

<pre><code>ember install ember-simple-auth
ember install torii
</code></pre>

<h3 id="setup-application-controller">Setup application controller</h3>

<p>There are many ways to setup simple-auth to handle the different session actions used for authentiation. For the purposes of this tutorial I’ll keep my app simple and just use the application controller for everything. Here we are injecting the simple-auth session and handling the actions authenticateSession and invalidateSession to perform the login and logout actions respectively. In both cases the action just calls an appropriate method on the session.</p>

<p>In the case of <code>authenticate</code> I’m passing the authenticator and TBD as parameters. Simple-auth comes with a bunch of builtin authenticators but in this case I need to use a custom one to handle the Oauth callback and serverside call required for authentication. By passing in “authenticator:torii” I’m telling simple-auth to look for the ember object defined in <code>/app/authenticator/torii.js</code>. The second parameter is for Torii but fuck all if i know what it does.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span>  <span style="color:#080;font-weight:bold">import</span> Ember from <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ember</span><span style="color:#710">'</span></span>;
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  <span style="color:#080;font-weight:bold">export</span> <span style="color:#080;font-weight:bold">default</span> Ember.Controller.extend({
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>    <span style="color:#606">session</span>: Ember.inject.service(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">session</span><span style="color:#710">'</span></span>),
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>    <span style="color:#606">actions</span>: {
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>      authenticateSession() {
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>        <span style="color:#950">this</span>.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">session</span><span style="color:#710">'</span></span>).authenticate(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">authenticator:torii</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">google-oauth2</span><span style="color:#710">'</span></span>);
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>      },
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>      invalidateSession() {
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>        <span style="color:#950">this</span>.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">session</span><span style="color:#710">'</span></span>).invalidate();
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>      }
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>    }
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  });
</pre></div>
</div>
</div>

<h3 id="create-a-custom-torii-google-authenticator">Create a custom torii-google authenticator</h3>
<p>Here I’ve created a custom authenticator which will handle authentication token returned by Google. Note that it extends the Torii authenticator built into simple-auth and overrides its authenticate method. When this is run it will cause Torii to open a popup showing the familiar Google authenticate user interface. When that’s complete and successful the popup will close and the token argument to the promise resolve will contain the Google Oauth token returned by google. Later we will send this token to our serverside to be resolved into the user’s email and google profile via google’s APIs.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span>  <span style="color:#777">//app/authenticators/torii.js</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  <span style="color:#080;font-weight:bold">import</span> Ember from <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ember</span><span style="color:#710">'</span></span>;
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  <span style="color:#080;font-weight:bold">import</span> Torii from <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ember-simple-auth/authenticators/torii</span><span style="color:#710">'</span></span>;
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>  const { service } = Ember.inject;
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  <span style="color:#080;font-weight:bold">export</span> <span style="color:#080;font-weight:bold">default</span> Torii.extend({
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>    <span style="color:#606">torii</span>: service(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">torii</span><span style="color:#710">'</span></span>),
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>    authenticate(options) {
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>      <span style="color:#950">this</span>._super(options).then(<span style="color:#080;font-weight:bold">function</span> (token) {
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>        console.log(options, data);
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>      });
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>    }
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>  });
</pre></div>
</div>
</div>

<h3 id="setup-application-template">Setup application template</h3>

<p>Now I need a way to trigger the <code>authenticateSession</code> action so I created a super simple <code>appplication.hbs</code> with just a single link to trigger the action.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>  &lt;!-- //app/template/application.hbs --&gt;
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>  &lt;h2 id=&quot;title&quot;&gt;Ember Simple Auth with Torii and Google&lt;/h2&gt;
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>  &lt;div&gt;
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>    &lt;a {{action 'authenticateSession'}}&gt;Login&lt;/a&gt;
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>  &lt;/div&gt;
</pre></div>
</div>
</div>

<h3 id="configuring-torii-with-your-keys-from-google">Configuring Torii with your keys from google</h3>

<p>Now is when you’ll use the keys and callback url you created when setting up your google app and api client. You’ll want to add the following hash to the <code>//config/environment.js</code>. With these settings Torii will know what key to pass to Google when it visits the Google oauth2 authentication page (check name) and where to redirect to after the user has authenticated.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span>  <span style="color:#777">//config/environment.js</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  ENV.torii = {
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>    <span style="color:#606">providers</span>: {
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>      <span style="color:#606"><span style="color:#404">'</span><span>google-oauth2</span><span style="color:#404">'</span></span>: {
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>        <span style="color:#606">apiKey</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">161580081432-v9mnjust9nhchrf30ri81mtbr8mecje3.apps.googleusercontent.com</span><span style="color:#710">&quot;</span></span>,
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>        <span style="color:#606">redirectUri</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://localhost:4200/oauth2callback</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>      }
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>    }
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>  };
</pre></div>
</div>
</div>

<h3 id="run-it">Run it</h3>

<p>Once you have this all together you should be all set to test out the app.</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">LiftForward Tech Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>LiftForward Tech Blog</li>
          <li><a href="mailto:engineering@liftforward.com">engineering@liftforward.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
          <li>
            <a href="https://twitter.com/liftforward">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">liftforward</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
